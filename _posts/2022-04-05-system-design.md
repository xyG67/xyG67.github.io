---
layout: post
title: "系统设计入门"
date: 2022-04-05
---

良好的系统需要确保可靠性，降低运维成本。本文主要讨论如何分析需求，以及实现方式。参考System Design等资料。

# 1. 关注点

1.1 分析需求
在动手设计系统架构前，首先要摸清需求功能，清楚哪些部分需要重点关注。
- 确定系统功能点
- 预估用户数量
- 约定系统输入输出
- 计算数据量、QPS等参数
1.2 设计系统框架
列出主要功能模块，画系统框架图，定义功能模块（例如：API）输入输出
1.3 设计核心模块
深入研究核心模块的实现方法，探讨实现功能所需算法，存储方案、缓存等。
- 例如：设计短链系统时，考虑生成/存储短链的方法，讨论多种方案的优缺点，例如。
    - SQL or NoSql
    - 在线生成短链 or 离线生成短链
    - Hash碰撞问题等
1.4 系统可靠性
定位系统可承载上限，讨论如何增加可靠性、可扩展性等。
- 水平扩展系统
- Sharding
- 缓存
- 负载均衡


# 2. 系统设计相关的数值

http://highscalability.com/blog/2011/1/26/google-pro-tip-use-back-of-the-envelope-calculations-to-choo.html
-   L1 cache reference 0.5 ns
-   Branch mispredict 5 ns
-   L2 cache reference 7 ns
-   Mutex lock/unlock 100 ns
-   Main memory reference 100 ns
-   Compress 1K bytes with Zippy 10,000 ns
-   Send 2K bytes over 1 Gbps network 20,000 ns
-   Read 1 MB sequentially from memory 250,000 ns
-   Round trip within same datacenter 500,000 ns
-   Disk seek 10,000,000 ns
-   Read 1 MB sequentially from network 10,000,000 ns
-   Read 1 MB sequentially from disk 30,000,000 ns
-   Send packet CA->Netherlands->CA 150,000,000 ns

# 3. 经典场景解决方案

## 1. 短链

### 1.1 功能点
- 给定URL，系统自动生成短链
- 用户访问短链时，自动转到原始链接
- 支持指定有效时间
- 用户能自定义短链


### 1.2 资源估算
系统读QPS远高于写QPS
#### 1.2.1 QPS
假设5亿/月的新URL， 100：1的读写QPS比率。
短链的流量是 `500M * 100 = 50B`

假设每月写入QPS是50,000,000，则 QPS = `50000000/(30 * 24 * 3600) = ~200URLs/s`
读QPS是 200 * 100 = 20，000/s

#### 1.2.2 存储
假设每个URL保存5年，每月5亿新URL，整个数据库需要

 `5 * 500, 000, 000 * 12 = 30, 000, 000, 000`

假定每个URL 500byte, 整个DB需要 `30 billion * 500 bytes = 15TB`

#### 1.2.3 内存
缓存高热短链URL，假定二八原则，即前20%的URL承担80%的流量，粗估需要缓存每月前20%的短链。


`500Million * 20% = 100Million'

内存大小

`100Million * 500B = 500MB`


#### 1.2.4 带宽

每秒200 QPS写，上传带宽：`200 * 500B = 100KB/s`

下载带宽：`100KB/s * 100 = ~10MB/s`


### 1.3 设计API
略

### 1.4 设计DB
- 存储URLMapping
- 存储用户信息

### 1.5 核心算法
系统的核心模块即生成短链的模块。根据用户键入URL的PATH生成几位随机乱码，作为短链地址。

#### 1.5.1 在线生成短链——HASH
利用MD5或其他加密算法，对URL进行编码。MD5算法的HASH结果为128位的字符串。
再进行base64加密，base64是([A-Z, a-z, 0-9， +， -])，截取字符串前N个字符作为短链。
短链的编码结果有 64^N 种。

根据系统存储空间选择N长度，64^6 = ~281billion，可选6字长度编码。

问题点：
- 哈希碰撞：需要检查生成短链是否重复，再做处理。
- 短链唯一性：为保证不同用户输入URL后，得到的短链唯一性，在URL后pending uuid等身份标识，或遇到相同URL时，在原URL尾部pending递增数字。



#### 1.5.2 离线生成短链

实现离线服务，提前生成若干随机字符串，在获取短链时，从服务内抽取一个使用。

问题点：
- 容灾：增加主备，主机宕机时，备用服务可以接管离线分发功能。
- 并发：预先向不同服务器的内存发送定量密钥，保证每个服务器得到的短链不同。

### 1.6 数据分区
我们需要存储数十亿的URL，可做数据库分区，降低单机数据库负担。

#### 1.6.1 基于范围分区
根据URL首位字母分区（ａ－ｚ）, 缺点是存储分布不均

#### 1.6.2 基于HASH分区
根据HASH结果分区，将结果映射到N个区间中，极端条件下，该算法也存在数据平衡性问题，可考虑使用**一致性哈希算法**


## 2. 设计Instagram
### 2.1 功能点
- 支持Feed，关注用户的Post按时间排序
- 能上传、下载照片
- 支持关注用户

### 2.2 资源估算
询问DAU、延迟等参数
#### 2.2.1 DAU
假定 800Million DAU一天，平均每个用户刷10次请求。用户平均每隔10天发布一次照片。

读QPS：800,000,000 / (36000*24) * 10 = ~90k QPS
写QPS: 800,000,000 / (30000*24*10) = ~900 QPS

#### 2.2.2 存储
假定一张照片1M，存储5年。
存储上限 800,000,000 * 365 * 1M/10 = 146000TB = 146PB

### 2.3 框架设计
画系统框架图，考虑推送系统使用Push还是Pull

### 2.4 存储系统设计
#### 2.4.1 DB
数据库选型（SQL or NoSql），设计数据库数据表。
- 注意考虑分片
- 存储图片
- 存储用户信息
- 存储Feed表
- 关注表

云端文件系统（类似HDFS、S3）。

#### 2.4.2 Cache
- 数据库缓存：预加载下次Feed用户请求，LRU。
- CDN：提前在CDN节点缓存图片资源。

### 2.5 核心子服务设计——Feed




